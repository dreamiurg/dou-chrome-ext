<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body {
      min-width: 300px;
      max-width: 300px;
      overflow-x: hidden;
      font-family: Arial, sans-serif;
      font-size: 12px;
    }

    input, textarea {
      width: 300px;
    }

    input#save {
      font-weight: bold;
      width: auto;
    }

    label {
      font-weight: bold;
    }
  </style>
  <script>
    function onPageInfo(o) {
      document.getElementById("title").value = o.title;
      document.getElementById("url").value = o.url;
      document.getElementById("description").innerText = o.description;
    }

    function addBookmark(f) {
      var req = new XMLHttpRequest();

      submit_url = "http://sudoku.org.ua/svoloshyn/lab/digest-bookmarklet.php";

      // to test this ext locally, run 'node server.js' in console
      // and uncomment the following line
      // submit_url = "http://localhost:3000/";

      req.open("POST", submit_url, true);

      var params =
          "email=" + localStorage["email"] +
          "&u=" + document.getElementById("url").value +
          "&s=" + document.getElementById("title").value +
          "&d=" + document.getElementById("description").value;

      req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      req.setRequestHeader("Content-length", params.length);
      req.setRequestHeader("Connection", "close");

      req.send(params);

      req.onreadystatechange = function() {
        // If the request completed, close the extension popup
        if (req.readyState == 4)
          if (req.status == 200) {
            chrome.tabs.getSelected(null, function(tab) {
              chrome.browserAction.setBadgeText({text: 'ok', tabId: tab.id});
              chrome.browserAction.setBadgeBackgroundColor({color: [0, 255, 0, 255], tabId: tab.id});
            });

            window.close();
          }
      };

      return false;
    }

    // Call the getPageInfo function in the background page, passing in
    // our onPageInfo function as the callback
    window.onload = function() {
      var bg = chrome.extension.getBackgroundPage();
      bg.getPageInfo(onPageInfo);
    }
  </script>
</head>

<body>
<form id="addbookmark" onsubmit="addBookmark(this); return false;">
  <p>
    <label for="title">Название</label><br/>
    <input type="text" id="title" name="title" size="50" value=""/>
  </p>

  <p>
    <label for="url">URL</label><br/>
    <input type="text" id="url" name="url" size="50" value=""/>
  </p>

  <p>
    <label for="description">О чем это?</label><br/>
    <textarea id="description" name="description" rows="4" cols="35"></textarea><br/>
    <small><strong>Hint</strong>: Выделите текст на странице перед тем, как нажать кнопку DOU, и
      он будет скопирован сюда автоматически.
    </small>
  </p>
  <p align="right">
    <input id="save" type="submit" value="Отправить ссылку в DOU"/>
  </p>
</form>
</body>
</html>
