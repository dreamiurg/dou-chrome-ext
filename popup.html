<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body {
      width: 350px;
      overflow-x: hidden;
      font-family: Arial, sans-serif;
      font-size: 12px;
    }

    input, textarea {
      width: 350px;
      font-size: 11px;
    }

    input#save {
      font-weight: bold;
      width: auto;
    }

    label {
      font-weight: bold;
    }

    #scheme_warning {
      color: #8b0000;
    }
  </style>
  <script>
    function submitRecommendation(f) {
      var req = new XMLHttpRequest();

      submit_url = "http://sudoku.org.ua/svoloshyn/lab/digest-bookmarklet.php";

      // to test this ext locally, run 'node server.js' in console
      // and uncomment the following line
      // submit_url = "http://localhost:3000/";

      req.open("POST", submit_url, true);

      var params =
          "email=" + localStorage["email"] +
          "&u=" + document.getElementById("url").value +
          "&s=" + document.getElementById("title").value +
          "&d=" + document.getElementById("description").value;

      req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      req.setRequestHeader("Content-length", params.length);
      req.setRequestHeader("Connection", "close");

      req.send(params);

      req.onreadystatechange = function() {
        // If the request completed, close the extension popup
        if (req.readyState == 4)
          if (req.status == 200) {
            chrome.tabs.getSelected(null, function(tab) {
              chrome.browserAction.setBadgeText({text: 'ok', tabId: tab.id});
              chrome.browserAction.setBadgeBackgroundColor({color: [0, 255, 0, 255], tabId: tab.id});
            });

            window.close();
          }
      };

      return false;
    }

    chrome.extension.onConnect.addListener(function(port) {
      console.log('popup chrome.extension.onConnect.addListener');
        // This will get called by the content script we execute in
        // the tab as a result of the user pressing the browser action.
        port.onMessage.addListener(function(pageInfo) {
          document.getElementById("title").value = pageInfo.title;
          document.getElementById("url").value = pageInfo.url;
          document.getElementById("description").innerText = pageInfo.description;
        });
    });

    chrome.tabs.getSelected(null, function(tab) {
      if (tab.url.indexOf('http:') == 0 || tab.url.indexOf('https:') == 0) {
        chrome.tabs.executeScript(null, {file: "content_script.js"});
        document.getElementById("scheme_warning").style.display = 'none';
      } else {
        document.getElementById("scheme_warning").style.display = 'block';
      }
    });
    
    window.onload = function() {
      document.getElementById("email").innerHTML = localStorage["email"];
    };
  </script>
</head>

<body>
<form onsubmit="submitRecommendation(this); return false;">
  <p>
    <label for="title">Название</label><br/>
    <input type="text" id="title" name="title" size="50" value=""/>
  </p>

  <p>
    <label for="url">URL</label><br/>
    <input type="text" id="url" name="url" size="50" value=""/>
  </p>

  <p>
    <label for="description">О чем это?</label><br/>
    <textarea id="description" name="description" rows="4" cols="35"></textarea><br/>
    <small><strong>Hint</strong>: Выделите текст на странице перед тем, как нажать кнопку DOU, и он будет скопирован сюда автоматически. Для обратной связи вы указали email &lt;<span id="email"></span>&gt;, его можно настроить в опциях.
    </small>
  </p>
  <p align="right">
    <input id="save" type="submit" value="Отправить ссылку в DOU"/>
  </p>
  <p id="scheme_warning">
    Названия, URL и описание страницы подставляется автоматически только для протоколов http:// и https://
  </p>
</form>
</body>
</html>
