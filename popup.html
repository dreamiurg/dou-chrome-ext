<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <style>
    body {
      width: 350px;
      overflow-x: hidden;
      font-family: Arial, sans-serif;
      font-size: 12px;
    }

    input, textarea {
      width: 350px;
      font-size: 12px;
    }

    input#save {
      font-weight: bold;
      width: auto;
    }

    label {
      font-weight: bold;
    }

    #scheme_warning {
      color: #8b0000;
    }
  </style>

  <script type="text/javascript" src="jquery-1.6.4.js"></script>
  <script>
    function submitRecommendation() {
      var req = new XMLHttpRequest();

      submit_url = "http://sudoku.org.ua/svoloshyn/lab/digest-bookmarklet.php";

      // to test this ext locally, run 'node server.js' in console
      // and uncomment the following line
      submit_url = "http://localhost/";

      req.open("POST", submit_url, true);

      var params = $('form#recommendation').serialize();

      req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      req.setRequestHeader("Content-length", params.length);
      req.setRequestHeader("Connection", "close");

      req.send(params);

      req.onreadystatechange = function() {
        // If the request completed, close the extension popup
        if (req.readyState == 4) {
          // sometimes status is 0, this bug is yet to be fixed
          if (req.status == 200 || req.status == 0) {
            chrome.tabs.getSelected(null, function(tab) {
              chrome.browserAction.setBadgeText({text: 'ok', tabId: tab.id});
              chrome.browserAction.setBadgeBackgroundColor({color: [0, 255, 0, 255], tabId: tab.id});
            });

            window.close();
          }
        }
      };

      return false;
    }




    chrome.extension.onConnect.addListener(function(port) {
      // This will get called by the content script we execute in
      // the tab as a result of the user pressing the browser action.
      port.onMessage.addListener(function(pageInfo) {
        $("#u").val(pageInfo.url);
        $("#s").val(pageInfo.title);
        $("#d").text(pageInfo.description);
      });
    });

    chrome.tabs.getSelected(null, function(tab) {
      if (tab.url.indexOf('http:') == 0 || tab.url.indexOf('https:') == 0) {
        chrome.tabs.executeScript(null, {file: "content_script.js"});
        $("#scheme_warning").hide();
      } else {
        $("#scheme_warning").show();
      }
    });

    $(document).ready(function() {
      email = localStorage["email"];
      $("#email").val(email);

      // show email user specified in options
      if (email) {
        $("#email_msg").html("Для обратной связи вы указали email &lt;" + email + "&gt;");
      } else {
        $("#email_msg").html("Вы не указали email для обратной связи");
      }

      // open Options page upon click on options link
      $('#options_link').click(function() {
        extviews = chrome.extension.getViews({"type": "tab"});
        options_url = chrome.extension.getURL('options.html');

        function focusTab(tab) {
          // Focus the given tab
          chrome.tabs.update(tab.id, {"selected": true});
        }

        for (var i = 0; i++; i <= extviews.length) {
          if (i == extviews.length) {
            // Create new tab if past end of list and none open
            chrome.tabs.create(options_url);
          } else if (extviews[i].location.href == options_url) {
            // Get the tab's object and focus the tab
            extviews[i].chrome.tabs.getCurrent(focusTab);
            break;
          }
        }
      });

      $('#save').click(function() { submitRecommendation(); });
    });

    $("#msg").ajaxError(function(event, request, settings){
  $(this).append("<li>Error requesting page " + settings.url + "</li>");
});
  </script>
</head>

<body>
<form id="recommendation">
  <input type="hidden" id="email" name="email" value=""/>
  <p>
    <label for="title">Название</label><br/>
    <input type="text" id="s" name="s" size="50" value=""/>
  </p>

  <p>
    <label for="url">URL</label><br/>
    <input type="text" id="u" name="u" size="50" value=""/>
  </p>

  <p>
    <label for="description">О чем это?</label><br/>
    <textarea id="d" name="d" rows="4" cols="35"></textarea><br/>
    <small><strong>Hint</strong>: Выделите текст на странице перед тем, как нажать кнопку DOU, и он будет скопирован
      сюда автоматически. <span id="email_msg"></span>, его можно настроить в <a href="#" id="options_link">опциях</a>.
    </small>
  </p>
  <p align="right">
    <button id="save">Отправить ссылку в DOU</button>
  </p>

  <p id="scheme_warning">
    Названия, URL и описание страницы подставляется автоматически только для протоколов http:// и https://
  </p>

  <div id="msg"></div>
</form>
</body>
</html>
